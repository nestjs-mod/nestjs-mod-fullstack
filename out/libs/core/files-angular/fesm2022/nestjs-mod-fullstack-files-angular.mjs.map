{"version":3,"file":"nestjs-mod-fullstack-files-angular.mjs","sources":["../../../../../libs/core/files-angular/src/lib/services/files.service.ts","../../../../../libs/core/files-angular/src/lib/formly/image-file.component.ts","../../../../../libs/core/files-angular/src/lib/formly/formly-fields.ts","../../../../../libs/core/files-angular/src/nestjs-mod-fullstack-files-angular.ts"],"sourcesContent":["import { Inject, Injectable, InjectionToken } from '@angular/core';\nimport { FilesRestService } from '@nestjs-mod-fullstack/app-angular-rest-sdk';\nimport { PresignedUrls } from '@nestjs-mod-fullstack/app-rest-sdk';\nimport { Observable, from, map, mergeMap, of, tap } from 'rxjs';\n\nexport const MINIO_URL = new InjectionToken<string>('MinioURL');\n\n@Injectable({ providedIn: 'root' })\nexport class FilesService {\n  constructor(\n    @Inject(MINIO_URL)\n    private readonly minioURL: string,\n    private readonly filesRestService: FilesRestService\n  ) {}\n\n  getPresignedUrlAndUploadFile(file: null | undefined | string | File) {\n    if (!file) {\n      return of('');\n    }\n    if (typeof file !== 'string') {\n      return this.getPresignedUrl(file).pipe(\n        mergeMap((presignedUrls) =>\n          this.uploadFile({\n            file,\n            presignedUrls,\n          })\n        ),\n        map((presignedUrls) => presignedUrls.downloadUrl)\n      );\n    }\n    return of(file);\n  }\n\n  getPresignedUrl(file: File) {\n    return from(\n      this.filesRestService.filesControllerGetPresignedUrl(\n        this.getFileExt(file)\n      )\n    );\n  }\n\n  uploadFile({\n    file,\n    presignedUrls,\n  }: {\n    file: File;\n    presignedUrls: PresignedUrls;\n  }) {\n    return new Observable<PresignedUrls>((observer) => {\n      const outPresignedUrls: PresignedUrls = {\n        downloadUrl: presignedUrls.downloadUrl,\n        uploadUrl: presignedUrls.uploadUrl,\n      };\n      if (presignedUrls.uploadUrl) {\n        const xhr = new XMLHttpRequest();\n        xhr.open('PUT', outPresignedUrls.uploadUrl);\n        xhr.onreadystatechange = () => {\n          if (xhr.readyState === 4) {\n            if (xhr.status === 200) {\n              observer.next(outPresignedUrls);\n              observer.complete();\n            } else {\n              observer.error(new Error('Error in upload file'));\n            }\n          }\n        };\n        xhr.send(file);\n      } else {\n        observer.next(outPresignedUrls);\n        observer.complete();\n      }\n    });\n  }\n\n  deleteFile(downloadUrl: string) {\n    return from(this.filesRestService.filesControllerDeleteFile(downloadUrl));\n  }\n\n  openTargetURI(uri: string) {\n    if (this.isIOS()) {\n      document.location.href = uri;\n    } else {\n      const link = document.createElement('a');\n      link.target = '_blank';\n      link.href = uri;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n    }\n  }\n\n  private getFileExt(file: File) {\n    return file?.type?.split('/')?.[1].toLowerCase();\n  }\n\n  private isIOS() {\n    return (\n      [\n        'iPad Simulator',\n        'iPhone Simulator',\n        'iPod Simulator',\n        'iPad',\n        'iPhone',\n        'iPod',\n      ].includes(navigator.platform) ||\n      // iPad on iOS 13 detection\n      (navigator.userAgent.includes('Mac') && 'ontouchend' in document)\n    );\n  }\n}\n","import { AsyncPipe } from '@angular/common';\nimport { ChangeDetectionStrategy, Component, OnInit } from '@angular/core';\nimport { ReactiveFormsModule } from '@angular/forms';\nimport { FieldType, FieldTypeConfig, FormlyModule } from '@ngx-formly/core';\nimport { NzButtonModule } from 'ng-zorro-antd/button';\nimport { NzIconModule } from 'ng-zorro-antd/icon';\nimport { NzInputModule } from 'ng-zorro-antd/input';\nimport { NzModalModule } from 'ng-zorro-antd/modal';\nimport { NzUploadFile, NzUploadModule } from 'ng-zorro-antd/upload';\nimport { BehaviorSubject } from 'rxjs';\nimport { FilesService } from '../services/files.service';\nimport { marker } from '@jsverse/transloco-keys-manager/marker';\nimport { TranslocoPipe } from '@jsverse/transloco';\n\n@Component({\n  selector: 'image-file',\n  imports: [\n    ReactiveFormsModule,\n    FormlyModule,\n    NzInputModule,\n    NzButtonModule,\n    NzUploadModule,\n    NzModalModule,\n    NzIconModule,\n    AsyncPipe,\n    TranslocoPipe,\n  ],\n  changeDetection: ChangeDetectionStrategy.OnPush,\n  template: `\n    <nz-upload\n      [nzAccept]=\"'image/png, image/jpeg'\"\n      [nzListType]=\"'picture'\"\n      [nzFileList]=\"(fileList$ | async)!\"\n      (nzFileListChange)=\"onFileListChange($event)\"\n      [nzLimit]=\"1\"\n      [nzBeforeUpload]=\"beforeUpload\"\n    >\n      <button nz-button type=\"button\">\n        <span nz-icon [nzType]=\"(icon$ | async)!\"></span>\n        {{ title$ | async | transloco }}\n      </button>\n    </nz-upload>\n  `,\n})\nexport class ImageFileComponent\n  extends FieldType<FieldTypeConfig>\n  implements OnInit\n{\n  fileList$ = new BehaviorSubject<NzUploadFile[]>([]);\n  title$ = new BehaviorSubject<string>('');\n  icon$ = new BehaviorSubject<string>('');\n\n  constructor(private readonly filesService: FilesService) {\n    super();\n  }\n\n  ngOnInit(): void {\n    if (this.formControl.value) {\n      this.switchToReloadMode();\n      this.fileList$.next([\n        {\n          uid: this.formControl.value,\n          name: this.formControl.value.split('/').at(-1),\n          status: 'done',\n          url: this.formControl.value,\n        },\n      ]);\n    } else {\n      this.switchToUploadMode();\n    }\n  }\n\n  onFileListChange(files: NzUploadFile[]) {\n    if (files.length === 0) {\n      this.formControl.setValue(null);\n      this.fileList$.next([]);\n      this.switchToUploadMode();\n    }\n  }\n\n  beforeUpload = (file: NzUploadFile): boolean => {\n    this.formControl.setValue(file);\n    this.switchToReloadMode();\n    this.fileList$.next([file]);\n    return false;\n  };\n\n  private switchToReloadMode() {\n    this.icon$.next('reload');\n    this.title$.next(marker('files.image-file.change-file'));\n  }\n\n  private switchToUploadMode() {\n    this.icon$.next('upload');\n    this.title$.next(marker('files.image-file.select-file'));\n  }\n}\n","import { TypeOption } from '@ngx-formly/core/lib/models';\nimport { ImageFileComponent } from './image-file.component';\n\nexport const FILES_FORMLY_FIELDS: TypeOption[] = [\n  {\n    name: 'image-file',\n    component: ImageFileComponent,\n    extends: 'input',\n  },\n];\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":["i1.FilesService"],"mappings":"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"}